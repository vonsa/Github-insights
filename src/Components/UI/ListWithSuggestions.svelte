<script context="module" lang="ts">
  export interface MappedSuggestions {
    [key: string]: boolean
  }
</script>

<script lang="ts">
  import { tooltip$ } from '../../use/tooltip/tooltip'
  import MaskedIcon from '../Decoration/MaskedIcon.svelte'
  import Suggestions from './Suggestions.svelte'

  export let suggestions: readonly string[]

  let selection: string[] = []
  let inputValue: string
  let mappedSuggestions: MappedSuggestions

  $: mappedSuggestions = suggestions.reduce((acc, curr) => {
    return { ...acc, [curr]: true }
  }, {})

  function removeFromSelection(selected: string) {
    selection = selection.filter((item) => item !== selected)
    if (selected in mappedSuggestions) {
      mappedSuggestions[selected] = true
    }
  }

  function addToSelection(selected: string) {
    if (selection.includes(selected)) {
      tooltip$.next({ title: 'Already selected!', type: 'ERROR' })
      return
    } else if (selected === '' || selected === undefined) {
      tooltip$.next({ title: 'Input may not be empty', type: 'ERROR' })
      return
    }

    selection = [...selection, selected]
    if (selected in mappedSuggestions) {
      mappedSuggestions[selected] = false
    }
  }
</script>

<input type="text" bind:value={inputValue} />
<button on:click={() => addToSelection(inputValue)}>Submit</button>
{#each selection as item}
  <slot name="selected-item" {item} {removeFromSelection}>
    <div class="selected-item">
      <p>{item}</p>
      <MaskedIcon icon="close" on:click={() => removeFromSelection(item)} />
    </div>
  </slot>
{/each}
<Suggestions suggestions={mappedSuggestions}>
  <svelte:fragment let:suggestion>
    <button class="suggestion" on:click={() => addToSelection(suggestion)}>{suggestion}</button>
  </svelte:fragment>
</Suggestions>

<style lang="scss">
  .suggestion {
    background: crimson;
    color: white;
  }
</style>
